"use strict";(self.webpackChunkapp_viagens=self.webpackChunkapp_viagens||[]).push([[23],{3023:(V,f,i)=>{i.r(f),i.d(f,{ReportsModule:()=>Q});var h=i(6895),c=i(4006),d=i(3546),m=i(9549),b=i(4144),v=i(4385),C=i(4859),_=i(7392),u=i(9602),O=i(3238),l=i(7155),R=i(1572),P=i(7009),D=i(9132);const y=[{key:"sales",label:"Vendas",description:"Relat\xf3rio completo de vendas com detalhes dos clientes e vendedores",endpoint:"/reports/csv/sales"},{key:"trips",label:"Viagens",description:"Relat\xf3rio de viagens com datas, hor\xe1rios e tipos",endpoint:"/reports/csv/trips"},{key:"accounts-payable",label:"Contas a Pagar",description:"Relat\xf3rio de contas a pagar e transa\xe7\xf5es de d\xe9bito",endpoint:"/reports/csv/accounts-payable"},{key:"accounts-receivable",label:"Contas a Receber",description:"Relat\xf3rio de contas a receber e transa\xe7\xf5es de cr\xe9dito",endpoint:"/reports/csv/accounts-receivable"}];var M=i(8746),t=i(4650),p=i(529),x=i(2340),F=i(4004);let w=(()=>{class o{constructor(e){this.http=e,this.apiUrl=`${x.N.backendV1Url}/reports`}toYmd(e){if(!e)return;const a="string"==typeof e?new Date(e):e;return`${a.getFullYear()}-${String(a.getMonth()+1).padStart(2,"0")}-${String(a.getDate()).padStart(2,"0")}`}exportSalesReport(e){let a=new p.LE;const n=this.toYmd(e.startDate),r=this.toYmd(e.endDate);return n&&(a=a.set("start_date",n)),r&&(a=a.set("end_date",r)),this.http.get(`${this.apiUrl}/csv/sales`,{params:a,responseType:"blob",headers:{"mtm-token":`Bearer ${localStorage.getItem("token")??""}`}})}exportTripsReport(e){let a=new p.LE;const n=this.toYmd(e.startDate),r=this.toYmd(e.endDate);return n&&(a=a.set("start_date",n)),r&&(a=a.set("end_date",r)),this.http.get(`${this.apiUrl}/csv/trips`,{params:a,responseType:"blob",headers:{"mtm-token":`Bearer ${localStorage.getItem("token")??""}`}})}exportAccountsPayableReport(e){let a=new p.LE;return e.statusFilter&&(a=a.set("status_filter",e.statusFilter)),this.http.get(`${this.apiUrl}/csv/accounts-payable`,{params:a,responseType:"blob",headers:{"mtm-token":`Bearer ${localStorage.getItem("token")??""}`}})}exportAccountsReceivableReport(e){let a=new p.LE;return e.statusFilter&&(a=a.set("status_filter",e.statusFilter)),this.http.get(`${this.apiUrl}/csv/accounts-receivable`,{params:a,responseType:"blob",headers:{"mtm-token":`Bearer ${localStorage.getItem("token")??""}`}})}downloadFile(e,a){const n=window.URL.createObjectURL(e),r=document.createElement("a");r.href=n,r.download=a,document.body.appendChild(r),r.click(),document.body.removeChild(r),window.URL.revokeObjectURL(n)}getReportPreview(e,a){let n=new p.LE;if(a.startDate){const r=this.toYmd(a.startDate);r&&(n=n.set("start_date",r))}if(a.endDate){const r=this.toYmd(a.endDate);r&&(n=n.set("end_date",r))}return a.statusFilter&&(n=n.set("status_filter",a.statusFilter)),this.http.get(`${this.apiUrl}/csv/preview/${e}`,{params:n,headers:{"mtm-token":`Bearer ${localStorage.getItem("token")??""}`,"X-Tenant-Id":localStorage.getItem("tenant")??""}}).pipe((0,F.U)(r=>r.data))}}return o.\u0275fac=function(e){return new(e||o)(t.LFG(p.eN))},o.\u0275prov=t.Yz7({token:o,factory:o.\u0275fac,providedIn:"root"}),o})();function T(o,s){if(1&o&&(t.TgZ(0,"mat-option",15),t._uU(1),t.qZA()),2&o){const e=s.$implicit;t.Q6J("value",e.key),t.xp6(1),t.hij(" ",e.label," ")}}function k(o,s){if(1&o&&(t.TgZ(0,"mat-hint"),t._uU(1),t.qZA()),2&o){const e=t.oxw();t.xp6(1),t.Oqu(e.selectedReport.description)}}function Z(o,s){if(1&o&&(t.TgZ(0,"div",16)(1,"mat-form-field",17)(2,"mat-label"),t._uU(3,"Data Inicial"),t.qZA(),t._UZ(4,"input",18)(5,"mat-datepicker-toggle",19)(6,"mat-datepicker",null,20),t.qZA(),t.TgZ(8,"mat-form-field",17)(9,"mat-label"),t._uU(10,"Data Final"),t.qZA(),t._UZ(11,"input",21)(12,"mat-datepicker-toggle",19)(13,"mat-datepicker",null,22),t.qZA()()),2&o){const e=t.MAs(7),a=t.MAs(14);t.xp6(4),t.Q6J("matDatepicker",e),t.xp6(1),t.Q6J("for",e),t.xp6(6),t.Q6J("matDatepicker",a),t.xp6(1),t.Q6J("for",a)}}function S(o,s){if(1&o&&(t.TgZ(0,"mat-option",15),t._uU(1),t.qZA()),2&o){const e=s.$implicit;t.Q6J("value",e.value),t.xp6(1),t.hij(" ",e.label," ")}}function A(o,s){if(1&o&&(t.TgZ(0,"mat-form-field",5)(1,"mat-label"),t._uU(2,"Status"),t.qZA(),t.TgZ(3,"mat-select",23),t.YNc(4,S,2,2,"mat-option",7),t.qZA()()),2&o){const e=t.oxw();t.xp6(4),t.Q6J("ngForOf",e.statusOptions)}}function U(o,s){1&o&&(t.TgZ(0,"div",24),t._UZ(1,"mat-spinner"),t.TgZ(2,"p"),t._uU(3,"Processando relat\xf3rio..."),t.qZA()())}function I(o,s){if(1&o&&(t.TgZ(0,"th",34),t._uU(1),t.qZA()),2&o){const e=t.oxw().$implicit;t.xp6(1),t.Oqu(e)}}function N(o,s){if(1&o&&(t.TgZ(0,"td",35),t._uU(1),t.qZA()),2&o){const e=s.$implicit,a=t.oxw().$implicit;t.xp6(1),t.Oqu(e[a]||"-")}}function J(o,s){1&o&&(t.ynx(0,31),t.YNc(1,I,2,1,"th",32),t.YNc(2,N,2,1,"td",33),t.BQk()),2&o&&t.Q6J("matColumnDef",s.$implicit)}function $(o,s){1&o&&t._UZ(0,"tr",36)}function Y(o,s){1&o&&t._UZ(0,"tr",37)}function q(o,s){if(1&o&&(t.TgZ(0,"mat-card",25)(1,"mat-card-header")(2,"mat-card-title"),t._uU(3),t.qZA(),t.TgZ(4,"mat-card-subtitle"),t._uU(5),t.qZA()(),t.TgZ(6,"mat-card-content")(7,"div",26)(8,"table",27),t.YNc(9,J,3,1,"ng-container",28),t.YNc(10,$,1,0,"tr",29),t.YNc(11,Y,1,0,"tr",30),t.qZA()()()()),2&o){const e=t.oxw();t.xp6(3),t.hij("Preview - ",null==e.selectedReport?null:e.selectedReport.label,""),t.xp6(2),t.hij("",e.previewData.length," registro(s) encontrado(s)"),t.xp6(3),t.Q6J("dataSource",e.previewData),t.xp6(1),t.Q6J("ngForOf",e.displayedColumns),t.xp6(1),t.Q6J("matHeaderRowDef",e.displayedColumns),t.xp6(1),t.Q6J("matRowDefColumns",e.displayedColumns)}}const E=[{path:"",component:(()=>{class o{constructor(e,a,n){this.fb=e,this.reportsService=a,this.snackBar=n,this.reportTypes=y,this.selectedReport=null,this.isLoading=!1,this.previewData=[],this.displayedColumns=[],this.statusOptions=[],this.requiredDateTypes=["sales","trips"],this.reportForm=this.fb.group({reportType:["",c.kI.required],startDate:[""],endDate:[""],statusFilter:[""]})}ngOnInit(){this.reportForm.get("reportType")?.valueChanges.subscribe(e=>{const a=(e||"").replace(/_/g,"-");this.selectedReport=this.reportTypes.find(n=>n.key===a)||null,this.reportForm.get("reportType")?.setValue(a,{emitEvent:!1}),this.updateFormFields(),this.updateStatusOptions(),this.onReportChange()})}updateFormFields(){if(!this.selectedReport)return;const e=["sales","trips","accounts-payable","accounts-receivable"].includes(this.selectedReport.key);["accounts-payable","accounts-receivable"].includes(this.selectedReport.key),this.reportForm.get("startDate")?.clearValidators(),this.reportForm.get("endDate")?.clearValidators(),this.reportForm.get("statusFilter")?.clearValidators(),e&&this.requiredDateTypes.includes(this.selectedReport.key)&&(this.reportForm.get("startDate")?.setValidators([c.kI.required]),this.reportForm.get("endDate")?.setValidators([c.kI.required])),this.reportForm.updateValueAndValidity({emitEvent:!1})}updateStatusOptions(){this.statusOptions=this.selectedReport?"accounts-receivable"===this.selectedReport.key?[{value:"",label:"Todos"},{value:"PENDING",label:"Pendente"},{value:"RECEIVED",label:"Recebido"}]:"accounts-payable"===this.selectedReport.key?[{value:"",label:"Todos"},{value:"PENDING",label:"Pendente"},{value:"PAID",label:"Pago"}]:[]:[]}onReportChange(){try{this.selectedReport?(this.updateStatusOptions(),this.resetFilters(),this.loadPreview()):this.statusOptions=[]}catch{}}resetFilters(){try{this.reportForm.patchValue({startDate:null,endDate:null,statusFilter:""},{emitEvent:!1}),this.updateFormFields()}catch{}}loadPreview(){try{if(!this.selectedReport)return;const e=this.requiredDateTypes.includes(this.selectedReport.key),{startDate:a,endDate:n}=this.reportForm.value;if(e&&(!a||!n))return;this.onPreview()}catch(e){console.error("\u274c ERRO em loadPreview:",e),this.isLoading=!1}}getFilters(){const e=this.reportForm.value;return{startDate:e.startDate||void 0,endDate:e.endDate||void 0,statusFilter:e.statusFilter||void 0}}validateDateRange(){const{startDate:e,endDate:a}=this.reportForm.value;if(this.selectedReport&&this.requiredDateTypes.includes(this.selectedReport.key)&&(!e||!a))return!1;if(e&&a){const n=new Date(e);if(new Date(a)<n)return this.snackBar.open("A data final n\xe3o pode ser menor que a data inicial.","Fechar",{duration:3e3}),!1}return!0}onPreview(){if(!this.selectedReport||this.reportForm.invalid)return void this.snackBar.open("Selecione um relat\xf3rio v\xe1lido","Fechar",{duration:3e3});if(!this.validateDateRange())return;this.isLoading=!0;const e=this.getFilters();this.reportsService.getReportPreview(this.selectedReport.key,e).pipe((0,M.x)(()=>this.isLoading=!1)).subscribe({next:a=>{this.previewData=a,this.setDisplayColumns(),0===a.length&&this.snackBar.open("Nenhum dado encontrado para os filtros selecionados","Fechar",{duration:3e3})},error:a=>{console.error("Erro ao carregar preview:",a),this.snackBar.open("Erro ao carregar dados do relat\xf3rio","Fechar",{duration:3e3})}})}onExport(){if(!this.selectedReport||this.reportForm.invalid)return void this.snackBar.open("Selecione um relat\xf3rio v\xe1lido","Fechar",{duration:3e3});if(!this.validateDateRange())return;const e=this.getFilters();let a,n=`${this.selectedReport.key}_${(new Date).toISOString().split("T")[0]}.csv`;switch(this.selectedReport.key){case"sales":a=this.reportsService.exportSalesReport(e);break;case"trips":a=this.reportsService.exportTripsReport(e);break;case"accounts-payable":a=this.reportsService.exportAccountsPayableReport(e);break;case"accounts-receivable":a=this.reportsService.exportAccountsReceivableReport(e);break;default:return void this.snackBar.open("Tipo de relat\xf3rio inv\xe1lido","Fechar",{duration:3e3})}this.isLoading=!0,a.pipe((0,M.x)(()=>this.isLoading=!1)).subscribe({next:r=>{const g=r?.blob instanceof Blob?r.blob:r;this.reportsService.downloadFile(g,"string"==typeof r?.filename?r.filename:n),this.snackBar.open("Relat\xf3rio exportado com sucesso!","Fechar",{duration:3e3})},error:r=>{console.error("Erro ao exportar:",r),404===r?.status?this.snackBar.open(`404 Not Found \u2014 confira se a URL bate com o Swagger.\n${r?.url||""}`,"Fechar",{duration:5e3}):400===r?.status?this.snackBar.open(`400 Bad Request \u2014 ${r?.error?.detail||"Verifique os filtros."}`,"Fechar",{duration:5e3}):this.snackBar.open("Erro ao exportar relat\xf3rio","Fechar",{duration:3e3})}})}setDisplayColumns(){if(this.selectedReport&&0!==this.previewData.length)switch(this.selectedReport.key){case"sales":this.displayedColumns=["id","serviceOrderCode","sellDate","customerName","totalValue","sellerName"];break;case"trips":this.displayedColumns=["id","customerName","ticketType","airline","origin","departureDateTime"];break;case"accounts-payable":this.displayedColumns=["transactionId","saleId","customerName","amount","status","paymentDate"];break;case"accounts-receivable":this.displayedColumns=["transactionId","saleId","customerName","amount","status","receivedDate"]}else this.displayedColumns=[]}get showDateFields(){return!!this.selectedReport&&["sales","trips","accounts-payable","accounts-receivable"].includes(this.selectedReport.key)}get showStatusField(){return!!this.selectedReport&&["accounts-payable","accounts-receivable"].includes(this.selectedReport.key)}}return o.\u0275fac=function(e){return new(e||o)(t.Y36(c.qu),t.Y36(w),t.Y36(P.ux))},o.\u0275cmp=t.Xpm({type:o,selectors:[["app-reports-dashboard"]],decls:31,vars:9,consts:[[1,"reports-dashboard"],[1,"page-header"],[1,"page-description"],[1,"filter-card"],[1,"filter-form",3,"formGroup"],["appearance","outline",1,"full-width"],["formControlName","reportType"],[3,"value",4,"ngFor","ngForOf"],[4,"ngIf"],["class","date-fields",4,"ngIf"],["appearance","outline","class","full-width",4,"ngIf"],["mat-raised-button","","color","primary",3,"disabled","click"],["mat-raised-button","","color","accent",3,"disabled","click"],["class","loading-container",4,"ngIf"],["class","preview-card",4,"ngIf"],[3,"value"],[1,"date-fields"],["appearance","outline"],["matInput","","formControlName","startDate",3,"matDatepicker"],["matSuffix","",3,"for"],["startPicker",""],["matInput","","formControlName","endDate",3,"matDatepicker"],["endPicker",""],["formControlName","statusFilter"],[1,"loading-container"],[1,"preview-card"],[1,"table-container"],["mat-table","",1,"preview-table",3,"dataSource"],[3,"matColumnDef",4,"ngFor","ngForOf"],["mat-header-row","",4,"matHeaderRowDef"],["mat-row","",4,"matRowDef","matRowDefColumns"],[3,"matColumnDef"],["mat-header-cell","",4,"matHeaderCellDef"],["mat-cell","",4,"matCellDef"],["mat-header-cell",""],["mat-cell",""],["mat-header-row",""],["mat-row",""]],template:function(e,a){1&e&&(t.TgZ(0,"div",0)(1,"div",1)(2,"h1"),t._uU(3,"Relat\xf3rios"),t.qZA(),t.TgZ(4,"p",2),t._uU(5,"Visualize e exporte relat\xf3rios do sistema"),t.qZA()(),t.TgZ(6,"mat-card",3)(7,"mat-card-header")(8,"mat-card-title"),t._uU(9,"Filtros do Relat\xf3rio"),t.qZA()(),t.TgZ(10,"mat-card-content")(11,"form",4)(12,"mat-form-field",5)(13,"mat-label"),t._uU(14,"Tipo de Relat\xf3rio"),t.qZA(),t.TgZ(15,"mat-select",6),t.YNc(16,T,2,2,"mat-option",7),t.qZA(),t.YNc(17,k,2,1,"mat-hint",8),t.qZA(),t.YNc(18,Z,15,4,"div",9),t.YNc(19,A,5,1,"mat-form-field",10),t.qZA()(),t.TgZ(20,"mat-card-actions")(21,"button",11),t.NdJ("click",function(){return a.onPreview()}),t.TgZ(22,"mat-icon"),t._uU(23,"visibility"),t.qZA(),t._uU(24," Visualizar "),t.qZA(),t.TgZ(25,"button",12),t.NdJ("click",function(){return a.onExport()}),t.TgZ(26,"mat-icon"),t._uU(27,"download"),t.qZA(),t._uU(28," Exportar CSV "),t.qZA()()(),t.YNc(29,U,4,0,"div",13),t.YNc(30,q,12,6,"mat-card",14),t.qZA()),2&e&&(t.xp6(11),t.Q6J("formGroup",a.reportForm),t.xp6(5),t.Q6J("ngForOf",a.reportTypes),t.xp6(1),t.Q6J("ngIf",a.selectedReport),t.xp6(1),t.Q6J("ngIf",a.showDateFields),t.xp6(1),t.Q6J("ngIf",a.showStatusField),t.xp6(2),t.Q6J("disabled",a.isLoading||!a.selectedReport),t.xp6(4),t.Q6J("disabled",a.isLoading||!a.selectedReport),t.xp6(4),t.Q6J("ngIf",a.isLoading),t.xp6(1),t.Q6J("ngIf",a.previewData.length>0&&!a.isLoading))},dependencies:[h.sg,h.O5,c._Y,c.Fj,c.JJ,c.JL,c.sg,c.u,d.a8,d.dk,d.dn,d.n5,d.$j,d.hq,m.KE,m.bx,m.hX,m.R9,b.Nt,v.gD,O.ey,C.lW,_.Hw,u.Mq,u.hl,u.nW,l.BZ,l.fO,l.as,l.w1,l.Dz,l.nj,l.ge,l.ev,l.XQ,l.Gk,R.Ou],styles:[".reports-dashboard[_ngcontent-%COMP%]{padding:24px;max-width:1200px;margin:0 auto}.reports-dashboard[_ngcontent-%COMP%]   .page-header[_ngcontent-%COMP%]{margin-bottom:32px}.reports-dashboard[_ngcontent-%COMP%]   .page-header[_ngcontent-%COMP%]   h1[_ngcontent-%COMP%]{font-size:2rem;font-weight:500;margin-bottom:8px;color:#333}.reports-dashboard[_ngcontent-%COMP%]   .page-header[_ngcontent-%COMP%]   .page-description[_ngcontent-%COMP%]{color:#666;font-size:1rem;margin:0}.reports-dashboard[_ngcontent-%COMP%]   .filter-card[_ngcontent-%COMP%]{margin-bottom:24px}.reports-dashboard[_ngcontent-%COMP%]   .filter-card[_ngcontent-%COMP%]   .filter-form[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:16px}.reports-dashboard[_ngcontent-%COMP%]   .filter-card[_ngcontent-%COMP%]   .filter-form[_ngcontent-%COMP%]   .full-width[_ngcontent-%COMP%]{width:100%}.reports-dashboard[_ngcontent-%COMP%]   .filter-card[_ngcontent-%COMP%]   .filter-form[_ngcontent-%COMP%]   .date-fields[_ngcontent-%COMP%]{display:grid;grid-template-columns:1fr 1fr;gap:16px}@media (max-width: 768px){.reports-dashboard[_ngcontent-%COMP%]   .filter-card[_ngcontent-%COMP%]   .filter-form[_ngcontent-%COMP%]   .date-fields[_ngcontent-%COMP%]{grid-template-columns:1fr}}.reports-dashboard[_ngcontent-%COMP%]   .filter-card[_ngcontent-%COMP%]   mat-card-actions[_ngcontent-%COMP%]{display:flex;gap:12px;padding:16px 24px}.reports-dashboard[_ngcontent-%COMP%]   .filter-card[_ngcontent-%COMP%]   mat-card-actions[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]{min-width:140px}.reports-dashboard[_ngcontent-%COMP%]   .filter-card[_ngcontent-%COMP%]   mat-card-actions[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]   mat-icon[_ngcontent-%COMP%]{margin-right:8px}.reports-dashboard[_ngcontent-%COMP%]   .loading-container[_ngcontent-%COMP%]{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:48px;text-align:center}.reports-dashboard[_ngcontent-%COMP%]   .loading-container[_ngcontent-%COMP%]   mat-spinner[_ngcontent-%COMP%]{margin-bottom:16px}.reports-dashboard[_ngcontent-%COMP%]   .loading-container[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]{color:#666;font-size:1rem}.reports-dashboard[_ngcontent-%COMP%]   .preview-card[_ngcontent-%COMP%]   .table-container[_ngcontent-%COMP%]{max-height:500px;overflow:auto;border:1px solid #e0e0e0;border-radius:4px}.reports-dashboard[_ngcontent-%COMP%]   .preview-card[_ngcontent-%COMP%]   .preview-table[_ngcontent-%COMP%]{width:100%}.reports-dashboard[_ngcontent-%COMP%]   .preview-card[_ngcontent-%COMP%]   .preview-table[_ngcontent-%COMP%]   th[_ngcontent-%COMP%], .reports-dashboard[_ngcontent-%COMP%]   .preview-card[_ngcontent-%COMP%]   .preview-table[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]{padding:12px 16px;text-align:left;border-bottom:1px solid #e0e0e0}.reports-dashboard[_ngcontent-%COMP%]   .preview-card[_ngcontent-%COMP%]   .preview-table[_ngcontent-%COMP%]   th[_ngcontent-%COMP%]{background-color:#f5f5f5;font-weight:600;color:#333;position:sticky;top:0;z-index:1}.reports-dashboard[_ngcontent-%COMP%]   .preview-card[_ngcontent-%COMP%]   .preview-table[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]{color:#555}.reports-dashboard[_ngcontent-%COMP%]   .preview-card[_ngcontent-%COMP%]   .preview-table[_ngcontent-%COMP%]   tr[_ngcontent-%COMP%]:hover{background-color:#f9f9f9}@media (max-width: 768px){.reports-dashboard[_ngcontent-%COMP%]{padding:16px}.reports-dashboard[_ngcontent-%COMP%]   .filter-card[_ngcontent-%COMP%]   mat-card-actions[_ngcontent-%COMP%]{flex-direction:column}.reports-dashboard[_ngcontent-%COMP%]   .filter-card[_ngcontent-%COMP%]   mat-card-actions[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]{width:100%}}"]}),o})()},{path:"**",redirectTo:""}];let B=(()=>{class o{}return o.\u0275fac=function(e){return new(e||o)},o.\u0275mod=t.oAB({type:o}),o.\u0275inj=t.cJS({imports:[D.Bz.forChild(E),D.Bz]}),o})(),Q=(()=>{class o{}return o.\u0275fac=function(e){return new(e||o)},o.\u0275mod=t.oAB({type:o}),o.\u0275inj=t.cJS({imports:[h.ez,c.UX,B,d.QW,m.lN,b.c,v.LD,C.ot,_.Ps,u.FA,O.XK,l.p0,R.Cq,P.ZX]}),o})()}}]);